/**
 * @license
 * Copyright (c) 2014, 2019, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["ojs/ojcore","knockout","ojs/ojlogger"],function(e,t,n){"use strict";function r(){this.Init()}return e.Object.createSubclass(r,e.Object,"ComponentBinding.GlobalChangeQueue"),r.prototype.Init=function(){r.superclass.Init.call(this),this._trackers=[],this._queue=[]},r.prototype.registerComponentChanges=function(t){-1===this._trackers.indexOf(t)&&(this._trackers.push(t),this._delayTimer||(this._delayTimer=setTimeout(e.Object.createCallback(this,this._deliverChangesImpl),1),this._delayPromise=new Promise(function(e){this._delayPromiseResolver=e}.bind(this))))},r.prototype.deliverChanges=function(){this._delayTimer&&clearTimeout(this._delayTimer),this._deliverChangesImpl()},r.prototype.getThrottlePromise=function(){return this._delayPromise||Promise.resolve()},r.prototype._deliverChangesImpl=function(){this._delayTimer=null,this._resolveDelayPromise();var e=this._trackers;this._trackers=[];for(var t=0;t<e.length;t++){var n=e[t];this._queue.push({tracker:n,changes:n.flushChanges()})}for(;this._queue.length>0;){var r=this._queue.shift();r.tracker.applyChanges(r.changes)}},r.prototype._resolveDelayPromise=function(){this._delayPromise&&(this._delayPromiseResolver(),this._delayPromiseResolver=null,this._delayPromise=null)},(new function(){var e=new WeakMap,i={},o={},s="_ojExtended",a="_ojCacheScope",c=new r;function u(e){return new Function("$context","$element","with($context.$data||{}){with($context){return "+e+"}}")}function l(t,n,r){if(!r)return t(n,r);var i,o=e,s=r[a]||r;(i=o.get(s))||(i={},o.set(s,i));var c=i[n];return c||(c=t(n,r),i[n]=c),c}function h(e,t,n){var r=t.getBindingsString;if(r)return r.call(t,e,n);switch(e.nodeType){case 1:return e.getAttribute("data-bind");case 8:var i=e.nodeValue.match(/^\s*ko(?:\s+([\s\S]+))?\s*$/);return i?i[1]:null;default:return null}}this.install=function(){var e=t.bindingProvider,r=e.instance;if(!r.getBindingAccessors)return n.error("JET's Knockout bindings are not compatible with the current binding provider since it does not implement getBindingAccessors()"),this;var a={};e.instance=a;var c=[];return c.push("getBindingAccessors","nodeHasBindings","getBindings"),c.forEach(function(e){a[e]=function(e,n,r){var o="nodeHasBindings"===n;return function(s){if(o){var a=s.nodeType;if(1!==a&&8!==a)return!1}var c=r(n,e[n]),u=c?c.apply(e,arguments):null,l=i[n];if(null!=l){var h=arguments;l.forEach(function(n){var r=Array.prototype.slice.call(h);r.push(u,e),u=t.ignoreDependencies(n,null,r)})}return u}}(r,e,function(e,n){return"getBindingAccessors"!==e?n:function(e,n){return function(r,i){if(i[s]){var o=h(r,n,i),a=o?function(e,n){return l(function(e){var n=t.expressionRewriting.preProcessBindings(e,{valueAccessors:!0});return u("{"+n+"}")},e,n)}(o,i)(i,r):null;if(1===r.nodeType&&t.components.isRegistered(r.tagName.toLowerCase())){var c=e.call(n,r,i),d=c.component;d&&((a=a||{}).component=d)}return a}return e.call(n,r,i)}}(n,r)})}),a.preprocessNode=function(e){var n=e.preprocessNode;return function(r){var i,s,a=null;return 1===r.nodeType&&(i=o[r.nodeName.toLowerCase()]),i||(i=n,a=e),i&&(s=t.ignoreDependencies(i,a,[r])),Array.isArray(s)&&(s=function(e,n){for(var r=t.bindingProvider.instance,i=n.slice(0),o=n[0],s=0,a=0;s>=0;){var c=t.virtualElements.nextSibling(o);if(o!==e){var u=r.preprocessNode(o);Array.isArray(u)&&(i.splice.apply(i,[a,1].concat(u)),a+=u.length-1)}a+=1;var l=s+1;s=(o=c)?n.indexOf(o,l):-1,a+=s-l}return i}(r,s)),s}}(r),function(e){var t=e.nativeTemplateEngine.prototype,n="renderTemplateSource",r=t[n];t[n]=function(e,t,n,i){return r.call(this,e,t,n,i||document)}}(t),this},this.addPostprocessor=function(e){Object.keys(e).forEach(function(t){i[t]=i[t]||[],i[t].push(e[t])})},this.registerPreprocessor=function(e,t){o[e]=t},this.getBindingsString=function(e,t,n){return h(e,t,n)},this.extendBindingContext=function(e,t,n,r,i){var o={$current:t,$root:void 0,$parent:void 0,$parents:void 0};return n&&(o[n]=t),r&&(o[r]=t),e?o=e.extend(o):o.$data={},Object.defineProperty(o,a,{value:i}),Object.defineProperty(o,s,{value:!0}),o},this.createBindingExpressionEvaluator=function(e,t){return t[s]?u(e):new Function("$context","with($context){with($data||{}){return "+e+";}}")},this.createEvaluator=function(e,t){return l(this.createBindingExpressionEvaluator,e,t)},this.getGlobalChangeQueue=function(){return c},this.getThrottlePromise=function(){return this.getGlobalChangeQueue().getThrottlePromise()}}).install()});